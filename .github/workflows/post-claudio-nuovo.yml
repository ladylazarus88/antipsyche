name: ðŸ“¥ Claudio Posts Sync (FINAL WORKING)

on:
  workflow_dispatch:  # Testa manualmente, poi aggiungi schedule

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      # 2. Scarica post di Claudio
      - name: â¬‡ï¸ Download Claudio posts
        run: |
          echo "=== DOWNLOAD POSTS ==="
          
          mkdir -p claudio_new
          
          # Metodo SEMPLICE e SICURO
          git clone --depth=1 https://github.com/ladylazarus88/antipsyche-post.git temp_repo 2>/dev/null || true
          
          if [ -d "temp_repo/posts" ]; then
            cp temp_repo/posts/*.md claudio_new/ 2>/dev/null || true
            echo "âœ… Scaricati $(ls claudio_new/*.md 2>/dev/null | wc -l) file"
          else
            echo "âš ï¸  Nessun file trovato in posts/"
          fi
          
          rm -rf temp_repo 2>/dev/null || true
          
      # 3. COPIA INTELLIGENTE (versione SEMPLICE che FUNZIONA)
      - name: ðŸ“„ Simple smart copy
        run: |
          echo "=== COPIA INTELLIGENTE SEMPLICE ==="
          
          # Crea cartella destinazione
          mkdir -p src/content/blog/claudio
          
          # Contatori inizializzati
          COPIED=0
          SKIPPED=0
          
          # Verifica se ci sono file
          FILE_COUNT=$(ls claudio_new/*.md 2>/dev/null | wc -l)
          echo "ðŸ“Š File da processare: $FILE_COUNT"
          
          if [ $FILE_COUNT -eq 0 ]; then
            echo "âœ… Nessun file da copiare"
            exit 0
          fi
          
          # Per ogni file - versione SICURA
          for new_file in claudio_new/*.md; do
            if [ -f "$new_file" ]; then
              FILENAME=$(basename "$new_file")
              OLD_FILE="src/content/blog/claudio/$FILENAME"
              
              # 1. Se NON esiste: COPIA
              if [ ! -f "$OLD_FILE" ]; then
                echo "ðŸ†• NUOVO: $FILENAME"
                cp "$new_file" "$OLD_FILE"
                COPIED=$((COPIED + 1))
                
              # 2. Se ESISTE: controlla se diverso
              else
                # Usa cmp (piÃ¹ semplice di md5sum)
                if cmp -s "$new_file" "$OLD_FILE"; then
                  echo "â­ï¸  UGUALE: $FILENAME"
                  SKIPPED=$((SKIPPED + 1))
                else
                  echo "ðŸ”„ MODIFICATO: $FILENAME"
                  cp "$new_file" "$OLD_FILE"
                  COPIED=$((COPIED + 1))
                fi
              fi
            fi
          done
          
          echo "ðŸ“Š RIEPILOGO:"
          echo "   Copiati: $COPIED file"
          echo "   Saltati: $SKIPPED file"
          
          # Pulisci
          rm -rf claudio_new 2>/dev/null || true
          
      # 4. Commit
      - name: ðŸ’¾ Commit if changes
        run: |
          echo "=== COMMIT ==="
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Sincronizza
          git pull origin master --quiet
          
          # Aggiungi
          git add src/content/blog/claudio/
          
          if git diff --cached --quiet; then
            echo "âœ… Nessun cambiamento"
          else
            CHANGED=$(git diff --cached --name-only | wc -l)
            git commit -m "ðŸ“¥ Post Claudio: $CHANGED file - $(date +'%Y-%m-%d %H:%M')"
            git push origin master
            echo "ðŸŽ‰ Fatto!"
          fi
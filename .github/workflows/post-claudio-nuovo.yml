name: ğŸ“¥ Claudio Posts Sync (Fixed Error Handling)

on:
  workflow_dispatch:  # Solo manuale per ora, poi aggiungi schedule

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      # 2. Scarica post di Claudio
      - name: â¬‡ï¸ Download Claudio posts
        run: |
          echo "=== DOWNLOAD POSTS ==="
          
          mkdir -p claudio_new
          
          # Scarica con gestione errori
          set +e  # Non uscire al primo errore
          
          curl -s "https://api.github.com/repos/ladylazarus88/antipsyche-post/contents/posts" \
            | jq -r '.[] | select(.name | endswith(".md")) | .download_url' > files.txt 2>/dev/null
          
          if [ -s "files.txt" ]; then
            echo "ğŸ“¥ Scaricamento via API GitHub"
            while read url; do
              filename=$(basename "$url")
              echo "  Downloading: $filename"
              curl -s -L -o "claudio_new/$filename" "$url" || echo "  âš ï¸  Fallito: $filename"
            done < files.txt
            rm -f files.txt
          else
            echo "ğŸ“¥ Scaricamento via git clone (fallback)"
            git clone --depth=1 https://github.com/ladylazarus88/antipsyche-post.git temp_repo 2>/dev/null || true
            cp temp_repo/posts/*.md claudio_new/ 2>/dev/null || true
            rm -rf temp_repo 2>/dev/null || true
          fi
          
          set -e  # Ripristina exit on error
          
          FILE_COUNT=$(ls claudio_new/*.md 2>/dev/null | wc -l || echo "0")
          echo "âœ… Scaricati $FILE_COUNT file"
          
      # 3. COPIA INTELLIGENTE CON GESTIONE ERRORI MIGLIORATA
      - name: ğŸ“„ Smart copy with error handling
        run: |
          echo "=== COPIA INTELLIGENTE (con error handling) ==="
          
          # Crea cartella destinazione
          mkdir -p src/content/blog/claudio
          
          # Inizializza contatori
          COPIED=0
          SKIPPED=0
          ERRORS=0
          
          # Verifica se ci sono file da processare
          if [ $(ls claudio_new/*.md 2>/dev/null | wc -l) -eq 0 ]; then
            echo "âš ï¸  Nessun file .md trovato in claudio_new/"
            echo "ğŸ“Š RIEPILOGO: 0 file processati"
            exit 0  # Esci senza errore
          fi
          
          # Per ogni file scaricato
          for new_file in claudio_new/*.md; do
            if [ -f "$new_file" ]; then
              FILENAME=$(basename "$new_file")
              OLD_FILE="src/content/blog/claudio/$FILENAME"
              
              # 1. Se il file NON esiste: COPIA
              if [ ! -f "$OLD_FILE" ]; then
                echo "ğŸ†• NUOVO: $FILENAME"
                cp "$new_file" "$OLD_FILE" && ((COPIED++)) || ((ERRORS++))
                
              # 2. Se il file ESISTE: controlla hash
              else
                # Calcola hash (se md5sum non esiste, usa cmp)
                if command -v md5sum &> /dev/null; then
                  HASH_NEW=$(md5sum "$new_file" 2>/dev/null | cut -d' ' -f1 || echo "")
                  HASH_OLD=$(md5sum "$OLD_FILE" 2>/dev/null | cut -d' ' -f1 || echo "")
                  
                  if [ "$HASH_NEW" != "$HASH_OLD" ]; then
                    echo "ğŸ”„ MODIFICATO: $FILENAME (hash diverso)"
                    cp "$new_file" "$OLD_FILE" && ((COPIED++)) || ((ERRORS++))
                  else
                    echo "â­ï¸  UGUALE: $FILENAME (saltato)"
                    ((SKIPPED++))
                  fi
                else
                  # Fallback: usa cmp per confronto binario
                  if ! cmp -s "$new_file" "$OLD_FILE"; then
                    echo "ğŸ”„ MODIFICATO: $FILENAME (contenuto diverso)"
                    cp "$new_file" "$OLD_FILE" && ((COPIED++)) || ((ERRORS++))
                  else
                    echo "â­ï¸  UGUALE: $FILENAME (saltato)"
                    ((SKIPPED++))
                  fi
                fi
              fi
            fi
          done
          
          # Rimozione file orfani (OPZIONALE - commentata per sicurezza)
          # echo "ğŸ§¹ Verifica file orfani (disabilitata per sicurezza)..."
          # for old_file in src/content/blog/claudio/*.md 2>/dev/null; do
          #   if [ -f "$old_file" ]; then
          #     FILENAME=$(basename "$old_file")
          #     if [ ! -f "claudio_new/$FILENAME" ]; then
          #       echo "ğŸ—‘ï¸  RIMOSSO: $FILENAME"
          #       rm "$old_file" && ((COPIED++)) || ((ERRORS++))
          #     fi
          #   fi
          # done
          
          echo "ğŸ“Š RIEPILOGO COPIA:"
          echo "   Copiati/aggiornati: $COPIED file"
          echo "   Saltati (uguali): $SKIPPED file"
          echo "   Errori: $ERRORS"
          
          if [ $ERRORS -gt 0 ]; then
            echo "âš ï¸  ATTENZIONE: $ERRORS errori durante la copia"
          fi
          
          # Pulisci cartella temporanea (SENZA uscire se fallisce)
          echo "ğŸ§¹ Pulizia cartella temporanea..."
          rm -rf claudio_new 2>/dev/null || echo "âš ï¸  Pulizia fallita, ma continuo"
          
      # 4. DEBUG: Mostra stato attuale
      - name: ğŸ” Debug current state
        if: always()  # Esegui SEMPRE, anche se step precedente fallisce
        run: |
          echo "=== DEBUG STATO ATTUALE ==="
          echo "ğŸ“ Contenuto di src/content/blog/claudio/:"
          ls -la src/content/blog/claudio/ 2>/dev/null || echo "Cartella non trovata"
          
          echo "ğŸ“„ Contenuto primo file (prime 5 righe):"
          head -5 src/content/blog/claudio/*.md 2>/dev/null | head -5 || echo "Nessun file"
          
          echo "ğŸ”¢ Numero file:"
          ls src/content/blog/claudio/*.md 2>/dev/null | wc -l || echo "0"
          
      # 5. Commit solo se cambiamenti REALI
      - name: ğŸ’¾ Commit if changes
        if: success()  # Solo se tutti gli step precedenti hanno successo
        run: |
          echo "=== COMMIT ==="
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Sincronizza
          echo "ğŸ”„ Sincronizzo con repository remoto..."
          git pull origin master --quiet --no-edit
          
          # Aggiungi file
          echo "ğŸ“ Aggiungo file alla staging area..."
          git add src/content/blog/claudio/
          
          # Verifica cambiamenti
          if git diff --cached --quiet; then
            echo "âœ… Nessun cambiamento reale nei file"
            echo "   (Tutti i file sono identici)"
          else
            # Mostra differenze
            echo "ğŸ“„ File con cambiamenti:"
            git diff --cached --name-only
            
            # Crea commit
            CHANGED_COUNT=$(git diff --cached --name-only | wc -l)
            echo "ğŸ“Š $CHANGED_COUNT file modificati"
            
            git commit -m "ğŸ“¥ Post Claudio aggiornati: $CHANGED_COUNT file - $(date +'%Y-%m-%d %H:%M')"
            
            # Push
            echo "ğŸš€ Push..."
            git push origin master
            
            echo "ğŸ‰ Commit creato e pushato!"
          fi
          
      # 6. Notifica errore finale
      - name: ğŸš¨ Notify if failed
        if: failure()
        run: |
          echo "âŒ WORKFLOW FALLITO!"
          echo "Ultimo messaggio di successo: 'ğŸ”„ MODIFICATO: recensione-cannibali-e-re-marvin-harris.md (hash diverso)'"
          echo ""
          echo "L'errore Ã¨ successivo alla copia del file."
          echo "Problemi possibili:"
          echo "1. Rimozione file orfani"
          echo "2. Conteggio finale"
          echo "3. Pulizia cartella claudio_new"
          echo ""
          echo "Controlla i log sopra per vedere dove si ferma."
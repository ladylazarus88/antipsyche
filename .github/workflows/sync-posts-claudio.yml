name: üì• Sync Claudio Posts (DEFINITIVE)

on:
  schedule:
    - cron: '0 */2 * * *'  # Ogni 2 ore
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout con tutta la cronologia
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ESSENZIALE: tutta la cronologia
          
      # 2. Scarica i post di Claudio
      - name: ‚¨áÔ∏è Get Claudio's posts
        run: |
          echo "=== SCARICO I POST DI CLAUDIO ==="
          
          mkdir -p temp_posts
          cd temp_posts
          
          git init
          git remote add origin https://github.com/ladylazarus88/antipsyche-post.git
          git config core.sparseCheckout true
          echo "posts/*" > .git/info/sparse-checkout
          git pull origin main --depth=1
          
          echo "üìä File trovati:"
          find posts -name "*.md" -type f | wc -l
          
          cd ..
          
      # 3. Copia nella cartella claudio/
      - name: üìÑ Copy to claudio folder
        run: |
          echo "=== COPIA IN claudio/ ==="
          
          # Ricrea la cartella da zero (pulita)
          rm -rf src/content/blog/claudio
          mkdir -p src/content/blog/claudio
          
          if [ -d "temp_posts/posts" ]; then
            # Copia preservando tutto
            find temp_posts/posts -name "*.md" -type f -exec cp {} src/content/blog/claudio/ \;
            
            COUNT=$(ls src/content/blog/claudio/*.md 2>/dev/null | wc -l)
            echo "‚úÖ Copiati $COUNT file"
            echo "üìÅ Primi file:"
            ls src/content/blog/claudio/ | head -5
          fi
          
          rm -rf temp_posts
          
      # 4. SINCRONIZZAZIONE SICURA (IL CUORE DEL WORKFLOW)
      - name: üíæ Safe sync with pull first
        run: |
          echo "=== SINCRONIZZAZIONE SICURA ==="
          
          # Configurazione Git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # 1. FETCH degli ultimi cambiamenti remoti
          echo "üîÑ Scarico gli ultimi cambiamenti da GitHub..."
          git fetch origin
          
          # 2. REBASE sui cambiamenti pi√π recenti (mantiene cronologia pulita)
          echo "üì¶ Applico le mie modifiche sui cambiamenti pi√π recenti..."
          if git rebase origin/main; then
            echo "‚úÖ Rebase completato"
          else
            # Se rebase fallisce (raro), fai merge
            echo "‚ö†Ô∏è  Rebase fallito, provo merge..."
            git merge origin/main --no-edit
            echo "‚úÖ Merge completato"
          fi
          
          # 3. Aggiungi i file modificati
          git add src/content/blog/claudio/
          
          # 4. Controlla se ci sono REALI cambiamenti
          if git diff --cached --quiet; then
            echo "‚úÖ Nessun cambiamento nei file (tutto gi√† aggiornato)"
            exit 0  # Esci senza errori
          fi
          
          # 5. Crea commit descrittivo
          CHANGED_FILES=$(git diff --cached --name-only | wc -l)
          git commit -m "üì• Post di Claudio: $CHANGED_FILES file aggiornati ($(date +'%Y-%m-%d %H:%M'))"
          
          # 6. PUSH con fallback automatico
          echo "üöÄ Invio i cambiamenti..."
          if git push origin main; then
            echo "üéâ Push completato con successo!"
          else
            # Fallback: pull e riprova (per sicurezza)
            echo "üîÑ Push fallito, sincronizzo e riprovo..."
            git pull origin main --rebase
            git push origin main
            echo "‚úÖ Push completato dopo sincronizzazione"
          fi
name: ğŸ“¥ Sync Claudio Posts (FIXED)

on:
  schedule:
    - cron: '0 */2 * * *'  # Ogni 2 ore
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout con tutta la cronologia
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Tutta la cronologia
          
      # 2. Scarica i post di Claudio (FIXED: usa 'main' se necessario)
      - name: â¬‡ï¸ Get Claudio's posts
        run: |
          echo "=== SCARICO I POST DI CLAUDIO ==="
          
          mkdir -p temp_posts
          cd temp_posts
          
          git init
          git remote add origin https://github.com/ladylazarus88/antipsyche-post.git
          git config core.sparseCheckout true
          echo "posts/*" > .git/info/sparse-checkout
          
          # Prova prima 'main', poi 'master'
          if git pull origin main --depth=1; then
            echo "âœ… Usato branch 'main'"
          elif git pull origin master --depth=1; then
            echo "âœ… Usato branch 'master'"
          else
            echo "âŒ Impossibile scaricare i post"
            exit 1
          fi
          
          echo "ğŸ“Š File trovati:"
          find posts -name "*.md" -type f | wc -l
          
          cd ..
          
      # 3. Copia nella cartella claudio/
      - name: ğŸ“„ Copy to claudio folder
        run: |
          echo "=== COPIA IN claudio/ ==="
          
          # Ricrea la cartella da zero
          rm -rf src/content/blog/claudio
          mkdir -p src/content/blog/claudio
          
          if [ -d "temp_posts/posts" ]; then
            # Copia i file .md
            find temp_posts/posts -name "*.md" -type f -exec cp {} src/content/blog/claudio/ \;
            
            COUNT=$(ls src/content/blog/claudio/*.md 2>/dev/null | wc -l)
            echo "âœ… Copiati $COUNT file"
            ls src/content/blog/claudio/ | head -5
          else
            echo "âš ï¸  Cartella posts/ non trovata in temp_posts"
          fi
          
          rm -rf temp_posts
          
      # 4. SINCRONIZZAZIONE SICURA (FIXED: gestione cambiamenti non committati)
      - name: ğŸ’¾ Safe sync with pull first
        run: |
          echo "=== SINCRONIZZAZIONE SICURA ==="
          
          # Configurazione Git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # ESSENZIALE: Pulizia prima di sincronizzare
          echo "ğŸ§¹ Pulisco lo stato locale..."
          git reset --hard
          git clean -fd
          
          # Sincronizza con il repository remoto
          echo "ğŸ”„ Sincronizzo con GitHub..."
          git fetch origin
          
          # Assicurati di essere sul branch corretto (master o main)
          CURRENT_BRANCH=$(git branch --show-current)
          echo "ğŸ“Œ Branch corrente: $CURRENT_BRANCH"
          
          # Riavvia dal commit remoto (pulizia totale)
          echo "ğŸ“¦ Reset al commit remoto..."
          git reset --hard origin/$CURRENT_BRANCH
          
          # Copia di nuovo i file dopo il reset (se necessario)
          echo "ğŸ”„ Ricopio i file di Claudio..."
          if [ -d "/tmp/claudio_backup" ]; then
            mkdir -p src/content/blog/claudio
            cp -r /tmp/claudio_backup/* src/content/blog/claudio/ 2>/dev/null || true
          fi
          
          # Aggiungi SOLO i file che vogliamo committare
          echo "ğŸ“ Aggiungo i file alla staging area..."
          git add src/content/blog/claudio/
          
          # Controlla se ci sono cambiamenti REALI
          if git diff --cached --quiet; then
            echo "âœ… Nessun cambiamento nei file"
            exit 0
          fi
          
          # Crea commit
          CHANGED_FILES=$(git diff --cached --name-only | wc -l)
          echo "ğŸ“„ File modificati: $CHANGED_FILES"
          git commit -m "ğŸ“¥ Post di Claudio: $CHANGED_FILES file ($(date +'%Y-%m-%d %H:%M'))"
          
          # Push
          echo "ğŸš€ Invio i cambiamenti..."
          git push origin $CURRENT_BRANCH
          
          echo "ğŸ‰ Sincronizzazione completata!"